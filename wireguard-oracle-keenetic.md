[![Donate](https://img.shields.io/badge/donate-Pizza-yellow.svg)](https://www.buymeacoffee.com/ntguest)
[![Donate](https://img.shields.io/badge/donate-Yandex-blueviolet.svg)](https://yoomoney.ru/to/410011383527168)
[![Donate](https://img.shields.io/badge/ask-Telegram-blue.svg)](https://t.me/avkulikoff)


# Настройка Keenetic как сервера WireGuard VPN 

Перейдите на страницу "Другие подключения" и в разделе "WireGuard" нажмите кнопку "Добавить подключение". Откроется окно настроек, в котором укажите название туннеля.
Нажмите кнопку "Генерация пары ключей" для создания Приватного и Публичного ключа. В дальнейшем нам понадобятся только Публичные ключи с двух сторон VPN-туннеля. Ключ от VPN-сервера нужно будет указать в настройках VPN-клиента и наоборот.

![image](https://user-images.githubusercontent.com/69485846/171141342-905b7bde-e4ee-4408-a00b-2e03521707f6.png)

В настройках WireGuard-подключения в поле "Адрес" впишите внутренний IP-адрес туннеля в формате IP/bitmask (в нашем примере это 172.16.82.1/24). Можно использовать любую подсеть из частного диапазона, которая не используется на стороне сервера и клиента.
В поле "Порт прослушивания" укажите номер порта, который будет использован при настройке VPN-клиента (в нашем примере это порт 16632). Именно на этот порт клиент будет обращаться при установлении туннеля. Роутер автоматически откроет этот порт на всех интерфейсах, чтобы проходили входящие подключения. Дополнительно добавлять разрешающие правила межсетевого экрана не нужно.

![image](https://user-images.githubusercontent.com/69485846/171142936-261f5629-cb56-4dd4-a1ca-fc031f56c249.png)

"Добавить пир" можно [после настройки на клиенте](https://github.com/ntguest/configs/edit/main/wireguard-oracle.md#4-%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%B0%D0%B8%D0%B2%D0%B0%D0%B5%D0%BC-%D1%83%D0%B4%D0%B0%D0%BB%D0%B5%D0%BD%D0%BD%D0%BE%D0%B5-%D0%BF%D0%BE%D0%B4%D0%BA%D0%BB%D1%8E%D1%87%D0%B5%D0%BD%D0%B8%D0%B5-%D0%BD%D0%B0-%D1%81%D1%82%D0%BE%D1%80%D0%BE%D0%BD%D0%B5-%D1%80%D0%B0%D0%BD%D0%B5%D0%B5-%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B5%D0%BD%D0%BD%D0%BE%D0%B3%D0%BE-wireguard-%D1%81%D0%B5%D1%80%D0%B2%D0%B5%D1%80%D0%B0)


На этом настройка WireGuard-подключения на стороне VPN-сервера завершена, но дополнительно на роутере нужно произвести настройку сетевого экрана и маршрутизации. Для созданного WireGuard-интерфейса нужно разрешить входящий трафик и указать статический маршрут в удаленную сеть.

Откройте страницу "Межсетевой экран". Для WireGuard-интерфейса (в нашем примере это "test-oracle") добавьте и включите разрешающее правило для IP-протокола. Это нужно, т.к. по умолчанию интерфейсам туннеля устанавливается публичный уровень безопасности и входящий трафик запрещен. Чтобы запросы из удаленных сетей могли проходить по туннелю, соответствующую настройку нужно будет выполнить на роутерах.

![image](https://user-images.githubusercontent.com/69485846/171145375-bbaf2c7d-9f41-46a1-ab70-ddbec79c4329.png)

![image](https://user-images.githubusercontent.com/69485846/171145621-643b3eb8-1eb2-4b95-9a27-a2db0d763537.png)

Чтобы по туннелю отправлялся трафик в удаленную сеть, нужно добавить статический маршрут.
Перейдите на страницу "Маршрутизация", нажмите на кнопку "Добавить маршрут" и укажите следующие параметры статического маршрута:

В поле "Тип маршрута" выберите значение "Маршрут до сети", в поле "Адрес сети назначения" укажите удаленную подсеть (в нашем примере это 192.168.100.0) и в поле "Интерфейс" выберите имя созданного ранее WireGuard-интерфейса (в нашем примере это "test-oracle"), включите опцию "Добавлять автоматически".

![image](https://user-images.githubusercontent.com/69485846/171146404-fe37e3da-9823-4aea-8381-4a9c2b7b8e0c.png)


https://help.keenetic.com/hc/ru/articles/360012075879


# Подключение по протоколу WireGuard VPN из Linux

## 1. Установка необходимых пакетов:
Заходим в терминал и выполняем установку необходимых пакетов для подключения WireGuard- туннеля в терминале и для настройки подключения в Сетевых соединениях (Networkmanager GUI — программа для управления сетевыми соединениями): пакет приложения, модуль ядра, заголовочные файлы ядра.
```bash
apt update && apt upgrade -y && apt autoremove -y
apt install wireguard wireguard-dkms
```

## 2. Переходим к созданию приватного ключа Private Key и публичного ключа Public Key:

```bash
cd /etc/wireguard/
umask 077
wg genkey > private-key
wg pubkey > public-key < private-key
cat private-key
cat public-key 
```

## 3. Создадим файл конфигурации wg-client.conf:

```bash
nano wg-client.conf


[Interface]
PrivateKey = <private-key>
Address = 172.16.82.3/24
DNS = 8.8.8.8

[Peer]
PublicKey = <PublicKey from router>
AllowedIPs = 172.16.82.1/32, 192.168.22.0/24, 192.168.0.0/24
Endpoint = <router IP>:16632
PersistentKeepalive = 5
```

Настройка [Peer] сервера:

В поле <PublicKey from router> вставьте публичный ключ сервера, который можно скопировать в буфер обмена компьютера из настроек WireGuard в веб-интерфейсе роутера:

![image](https://user-images.githubusercontent.com/69485846/171133794-78456d6d-5e87-4fce-8d60-6769718ed58b.png)

В поле "AllowedIPs" указываем разрешенные IP-адреса, в формате IP/bitmask — 172.16.82.1/32 (это внутренний адрес сервера) и 192.168.22.0/24 (адрес локального сегмента роутера Keenetic).

В поле "Endpoint" указываем публичный IP-адрес или доменное имя WireGuard-сервера, и порт прослушивания, на который будет устанавливать связь WireGuard-клиент.

В поле "PersistentKeepalive" указываем периодичность попыток проверки доступности удаленной стороны соединения. Обычно, достаточно 3-5-секундного интервала между проверками.

## 4. Настраиваем удаленное подключение на стороне ранее настроенного WireGuard-сервера.

Подключитесь к веб-конфигуратору роутера и перейдите в меню "Интернет" на страницу "Другие подключения". Нажмите на ранее созданное WireGuard-подключение ("WG-S") и добавьте "Настройки пира". Нажав на "Добавить пир" откроется поле настроек пира, в котором укажите название туннеля "wg-ubuntu-client".

В поле "Публичный ключ" вставляем ключ, который был создан в пункте 2.
Напоминаем, что посмотреть ключ можно при помощи вывода команды cat:

```bash
cat public-key
```

В поле "Разрешенные подсети" указываем адрес, трафик с которого будет допущен до сервера в формате IP/bitmask — 172.16.82.3/32

В поле "Проверка активности" необходимо указать периодичность попыток проверки доступности удаленной стороны соединения. Обычно достаточно 10-15 секундного интервала между проверками. По умолчанию значение "Проверки активности" в настройках пира Keenetic указано 30 секунд.

Нажмите "Сохранить".
![image](https://user-images.githubusercontent.com/69485846/171134448-d373953c-7a9c-4d59-87f6-bcfb076917ca.png)

## 5. Создаем автоматическое WireGuard-подключение при загрузке Linux:

```bash
systemctl enable wg-quick@wg-client.service
```

Важно! В имени сервиса ***.service - вводим имя конфигурации wg-client.conf

## 6. Запускаем WireGuard-подключение:

```bash
systemctl enable wg-quick@wg-client.service
apt install resolvconf
systemctl start wg-quick@wg-client.service
wg 
```

## 7. Для отключения автоматического запуска WireGuard-подключения:

```bash
disable wg-quick@wg-client.service
```

## 8. Для остановки WireGuard-подключения:

```bash
systemctl stop wg-quick@wg-client.service
```

## Настройка завершена.

https://help.keenetic.com/hc/ru/articles/360010511219

[![Donate](https://img.shields.io/badge/donate-Pizza-yellow.svg)](https://www.buymeacoffee.com/ntguest)
[![Donate](https://img.shields.io/badge/donate-Yandex-blueviolet.svg)](https://yoomoney.ru/to/410011383527168)
[![Donate](https://img.shields.io/badge/ask-Telegram-blue.svg)](https://t.me/avkulikoff)
